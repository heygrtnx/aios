<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AIOS – Stream</title>
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=IBM+Plex+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.hugeicons.com/font/hgi-stroke-rounded.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <style>
      :root {
        --bg: #f9f9f9;
        --bg-glass: rgba(249, 249, 249, 0.92);
        --surface: #ffffff;
        --surface-2: #f0f0f0;
        --border: rgba(0, 0, 0, 0.07);
        --border-hi: rgba(0, 0, 0, 0.12);
        --text: #0a0a0a;
        --text-2: #555555;
        --text-3: #999999;
        --accent: #0a0a0a;
        --amber: #92400e;
        --teal: #0e7490;
        --green: #166534;
        --red: #b91c1c;
        --red-dim: rgba(185, 28, 28, 0.05);
        --shimmer-mid: rgba(0, 0, 0, 0.045);
        --scrollbar: rgba(0, 0, 0, 0.13);
        --clear-hover-bg: rgba(0, 0, 0, 0.06);
        --focus-border: rgba(0, 0, 0, 0.28);
        --focus-shadow: rgba(0, 0, 0, 0.05);
        --focus-shadow2: rgba(0, 0, 0, 0.08);
        --pulse-shadow: rgba(0, 0, 0, 0.04);
        --pulse-shadow2: rgba(0, 0, 0, 0.1);
        --dot-color: rgba(0, 0, 0, 0.065);
        --r: 14px;
        --r-sm: 9px;
        --ui: 'Syne', system-ui, sans-serif;
        --mono: 'IBM Plex Mono', 'Fira Code', monospace;
      }

      html[data-theme='dark'] {
        --bg: #08080b;
        --bg-glass: rgba(8, 8, 11, 0.88);
        --surface: #0f0f13;
        --surface-2: #16161c;
        --border: rgba(255, 255, 255, 0.055);
        --border-hi: rgba(255, 255, 255, 0.09);
        --text: #ededf3;
        --text-2: #787893;
        --text-3: #4a4a62;
        --accent: #ededf3;
        --amber: #fbbf24;
        --teal: #22d3ee;
        --green: #4ade80;
        --red: #f87171;
        --red-dim: rgba(248, 113, 113, 0.07);
        --shimmer-mid: rgba(255, 255, 255, 0.04);
        --scrollbar: rgba(255, 255, 255, 0.12);
        --clear-hover-bg: rgba(255, 255, 255, 0.07);
        --focus-border: rgba(255, 255, 255, 0.22);
        --focus-shadow: rgba(255, 255, 255, 0.04);
        --focus-shadow2: rgba(0, 0, 0, 0.3);
        --pulse-shadow: rgba(255, 255, 255, 0.03);
        --pulse-shadow2: rgba(255, 255, 255, 0.08);
        --dot-color: rgba(255, 255, 255, 0.03);
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html,
      body {
        height: 100%;
      }

      body {
        height: 100dvh;
        font-family: var(--ui);
        background: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
      }

      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image: radial-gradient(
          circle,
          var(--dot-color) 1px,
          transparent 1px
        );
        background-size: 26px 26px;
        pointer-events: none;
        z-index: 0;
      }

      /* ─── Header ─────────────────────────────────── */
      .header {
        position: relative;
        z-index: 20;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1.25rem;
        border-bottom: 1px solid var(--border);
        background: var(--bg-glass);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        flex-shrink: 0;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 0.625rem;
      }

      .brand-icon {
        width: 30px;
        height: 30px;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: 8px;
        display: grid;
        place-items: center;
      }
      .brand-icon i {
        font-size: 15px;
        line-height: 1;
        color: var(--text-2);
      }

      .brand-name {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        line-height: 1;
      }
      .brand-name-main {
        font-size: 0.9375rem;
        font-weight: 800;
        letter-spacing: 0.05em;
      }
      .brand-name-main em {
        font-style: normal;
        color: var(--text-2);
      }
      .brand-name-sub {
        font-size: 0.6875rem;
        font-weight: 700;
        letter-spacing: 0.06em;
        color: var(--text);
      }

      .status {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.25rem 0.7rem;
        background: var(--surface-2);
        border: 1px solid var(--border);
        border-radius: 100px;
        font-size: 0.625rem;
        font-weight: 700;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: var(--text-3);
        transition:
          color 0.3s,
          background 0.3s,
          border-color 0.3s;
      }
      .status.s-thinking {
        color: var(--amber);
        background: rgba(146, 64, 14, 0.06);
        border-color: rgba(146, 64, 14, 0.18);
      }
      .status.s-streaming {
        color: var(--teal);
        background: rgba(14, 116, 144, 0.06);
        border-color: rgba(14, 116, 144, 0.18);
      }
      .status.s-done {
        color: var(--green);
        background: rgba(22, 101, 52, 0.06);
        border-color: rgba(22, 101, 52, 0.18);
      }
      .status.s-error {
        color: var(--red);
        background: var(--red-dim);
        border-color: rgba(185, 28, 28, 0.18);
      }

      html[data-theme='dark'] .status.s-thinking {
        background: rgba(251, 191, 36, 0.08);
        border-color: rgba(251, 191, 36, 0.2);
      }
      html[data-theme='dark'] .status.s-streaming {
        background: rgba(34, 211, 238, 0.08);
        border-color: rgba(34, 211, 238, 0.2);
      }
      html[data-theme='dark'] .status.s-done {
        background: rgba(74, 222, 128, 0.08);
        border-color: rgba(74, 222, 128, 0.2);
      }
      html[data-theme='dark'] .status.s-error {
        border-color: rgba(248, 113, 113, 0.2);
      }

      .status-dot {
        width: 5px;
        height: 5px;
        border-radius: 50%;
        background: currentColor;
        flex-shrink: 0;
      }
      .status.s-thinking .status-dot,
      .status.s-streaming .status-dot {
        animation: pulse-dot 0.9s ease-in-out infinite;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 1;
          transform: scale(1);
        }
        50% {
          opacity: 0.25;
          transform: scale(0.7);
        }
      }

      /* ─── Main ───────────────────────────────────── */
      .main {
        position: relative;
        z-index: 1;
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
      }

      /* ─── Chat scroll area ───────────────────────── */
      .chat-wrap {
        flex: 1;
        overflow-y: auto;
      }
      .chat-wrap::-webkit-scrollbar {
        width: 3px;
      }
      .chat-wrap::-webkit-scrollbar-track {
        background: transparent;
      }
      .chat-wrap::-webkit-scrollbar-thumb {
        background: var(--scrollbar);
        border-radius: 2px;
      }

      .chat-inner {
        max-width: 42rem;
        margin: 0 auto;
        padding: 2rem 1.25rem 2.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
        min-height: 100%;
      }

      /* ─── Empty / welcome state ──────────────────── */
      #empty-state {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        text-align: center;
        padding: 2rem 0;
      }

      .ph-icon {
        width: 46px;
        height: 46px;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: 13px;
        display: grid;
        place-items: center;
        margin-bottom: 0.25rem;
      }
      .ph-icon i {
        font-size: 22px;
        line-height: 1;
        color: var(--text-3);
      }
      .ph-title {
        font-size: 0.9375rem;
        font-weight: 600;
        color: var(--text-2);
      }
      .ph-sub {
        font-size: 0.8125rem;
        color: var(--text-3);
        line-height: 1.6;
      }

      /* ─── Chat messages ──────────────────────────── */
      .msg {
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
        animation: msg-in 0.18s ease;
      }
      @keyframes msg-in {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* User bubble — right aligned */
      .msg-user {
        align-items: flex-end;
      }
      .msg-bubble {
        max-width: 78%;
        background: var(--accent);
        color: var(--bg);
        padding: 0.625rem 0.9375rem;
        border-radius: 18px 18px 4px 18px;
        font-size: 0.9375rem;
        font-weight: 400;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .msg-paste-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.5rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        font-family: var(--mono);
        font-size: 0.6875rem;
        color: inherit;
        margin-top: 0.5rem;
      }
      html[data-theme='dark'] .msg-paste-pill {
        background: rgba(0, 0, 0, 0.1);
        border-color: rgba(0, 0, 0, 0.18);
      }
      .msg-paste-pill i {
        font-size: 11px;
        line-height: 1;
        flex-shrink: 0;
        opacity: 0.7;
      }

      /* AI message — left aligned */
      .msg-ai {
        align-items: flex-start;
      }

      .msg-badge {
        display: inline-flex;
        align-items: center;
        font-size: 0.5625rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text-2);
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: 4px;
        padding: 0.1875rem 0.5rem;
      }

      .msg-text {
        font-family: var(--mono);
        font-size: 0.875rem;
        font-weight: 300;
        line-height: 1.85;
        word-break: break-word;
        color: var(--text);
        letter-spacing: 0.008em;
        max-width: 100%;
      }
      .msg-text p {
        margin: 0 0 0.5em;
      }
      .msg-text p:last-of-type {
        margin-bottom: 0;
      }
      .msg-text h1,
      .msg-text h2,
      .msg-text h3,
      .msg-text h4,
      .msg-text h5,
      .msg-text h6 {
        font-family: var(--ui);
        font-weight: 700;
        margin: 0.75em 0 0.35em;
        line-height: 1.3;
        color: var(--text);
      }
      .msg-text h1 {
        font-size: 1.125rem;
      }
      .msg-text h2 {
        font-size: 1rem;
      }
      .msg-text h3,
      .msg-text h4,
      .msg-text h5,
      .msg-text h6 {
        font-size: 0.9375rem;
      }
      .msg-text strong {
        font-weight: 600;
        color: var(--text);
      }
      .msg-text em {
        font-style: italic;
      }
      .msg-text code {
        font-family: var(--mono);
        font-size: 0.8125rem;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: 4px;
        padding: 0.1em 0.4em;
      }
      .msg-text pre {
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: var(--r-sm);
        padding: 0.875rem 1rem;
        overflow-x: auto;
        margin: 0.5em 0;
      }
      .msg-text pre code {
        background: none;
        border: none;
        padding: 0;
        font-size: 0.8125rem;
        white-space: pre;
      }
      .msg-text ul,
      .msg-text ol {
        padding-left: 1.5em;
        margin: 0.35em 0;
      }
      .msg-text li {
        margin: 0.2em 0;
      }
      .msg-text blockquote {
        border-left: 3px solid var(--border-hi);
        padding-left: 0.875rem;
        margin: 0.5em 0;
        color: var(--text-2);
      }
      .msg-text a {
        color: var(--teal);
        text-decoration: underline;
      }
      .msg-text hr {
        border: none;
        border-top: 1px solid var(--border-hi);
        margin: 0.75em 0;
      }
      /* Thinking shimmer */
      .msg-thinking {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        width: 18rem;
        max-width: 100%;
        padding-top: 0.125rem;
      }
      .shimmer-line {
        height: 0.625rem;
        border-radius: 4px;
        background: linear-gradient(
          90deg,
          var(--surface-2) 0%,
          var(--shimmer-mid) 45%,
          var(--surface-2) 100%
        );
        background-size: 200% 100%;
        animation: shimmer 1.6s ease-in-out infinite;
      }
      .msg-thinking .shimmer-line:nth-child(1) {
        width: 100%;
      }
      .msg-thinking .shimmer-line:nth-child(2) {
        width: 80%;
      }
      .msg-thinking .shimmer-line:nth-child(3) {
        width: 55%;
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* Inline error */
      .msg-error {
        font-family: var(--mono);
        font-size: 0.8125rem;
        line-height: 1.55;
        color: var(--red);
        padding: 0.75rem 0.9375rem;
        background: var(--red-dim);
        border: 1px solid rgba(185, 28, 28, 0.14);
        border-radius: var(--r-sm);
        max-width: 100%;
      }

      /* ─── Message action buttons ─────────────── */
      .msg-actions {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      .msg-actions-user { align-self: flex-end; }
      .msg-actions-ai   { align-self: flex-start; }

      .msg-action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: none;
        border: none;
        border-radius: 6px;
        color: var(--text-3);
        cursor: pointer;
        flex-shrink: 0;
        transition: color 0.15s;
      }
      .msg-action-btn:hover { color: var(--text-2); }
      .msg-action-btn.copied { color: var(--green); }
      .msg-action-btn i { font-size: 15px; line-height: 1; }

      /* ─── Email card ──────────────────────────── */
      .msg-email-card {
        background: var(--surface);
        border: 1px solid var(--border-hi);
        border-radius: var(--r);
        overflow: hidden;
        max-width: 100%;
      }
      .msg-email-hd {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        background: var(--surface-2);
        border-bottom: 1px solid var(--border-hi);
      }
      .msg-email-label {
        font-size: 0.5625rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--text-3);
      }
      .msg-email-hd-actions {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      .msg-email-icon-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: var(--surface);
        border: 1px solid var(--border-hi);
        border-radius: 6px;
        color: var(--text-2);
        cursor: pointer;
        transition: background 0.15s, color 0.15s, border-color 0.15s;
        flex-shrink: 0;
        box-shadow: 0 1px 3px var(--focus-shadow2);
      }
      .msg-email-icon-btn:hover {
        background: var(--surface-2);
        color: var(--text);
        border-color: var(--focus-border);
        box-shadow: 0 2px 6px var(--focus-shadow2);
      }
      .msg-email-icon-btn.copied { color: var(--green); border-color: currentColor; }
      .msg-email-icon-btn i { font-size: 13px; line-height: 1; }
      .msg-email-subject {
        display: flex;
        align-items: baseline;
        gap: 0.625rem;
        padding: 0.6875rem 1rem;
        border-bottom: 1px solid var(--border);
      }
      .msg-email-subject-lbl {
        font-size: 0.6875rem;
        font-weight: 700;
        color: var(--text-3);
        letter-spacing: 0.05em;
        flex-shrink: 0;
      }
      .msg-email-subject-txt {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text);
        line-height: 1.4;
      }
      .msg-email-body {
        padding: 1rem;
        font-family: var(--mono);
        font-size: 0.875rem;
        font-weight: 300;
        line-height: 1.85;
        color: var(--text);
        letter-spacing: 0.008em;
      }
      .msg-email-body p { margin: 0 0 0.65em; }
      .msg-email-body p:last-of-type { margin-bottom: 0; }
      .msg-email-body strong { font-weight: 600; color: var(--text); }
      .msg-email-placeholder {
        display: inline-block;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.22);
        border-radius: 4px;
        padding: 0.05em 0.35em;
        font-family: var(--mono);
        font-size: 0.9em;
        color: var(--text);
      }
      html[data-theme='dark'] .msg-email-placeholder {
        background: rgba(129, 140, 248, 0.13);
        border-color: rgba(129, 140, 248, 0.24);
      }

      .hidden {
        display: none !important;
      }

      /* ─── Paste strip ────────────────────────────── */
      #paste-strip {
        display: none;
        flex-wrap: wrap;
        gap: 0.375rem;
        padding: 0.625rem 0.75rem 0;
      }
      #paste-strip.has-pill {
        display: flex;
      }

      .paste-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.25rem 0.3125rem 0.25rem 0.5rem;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: 6px;
        font-family: var(--mono);
        font-size: 0.6875rem;
        color: var(--text-2);
        max-width: 100%;
      }
      .paste-pill i {
        font-size: 11px;
        line-height: 1;
        flex-shrink: 0;
        color: var(--text-3);
      }
      .paste-pill-label {
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        max-width: 22rem;
      }
      .paste-pill-remove {
        display: grid;
        place-items: center;
        width: 16px;
        height: 16px;
        background: transparent;
        border: none;
        border-radius: 4px;
        color: var(--text-3);
        cursor: pointer;
        flex-shrink: 0;
        padding: 0;
        transition:
          background 0.15s,
          color 0.15s;
      }
      .paste-pill-remove:hover {
        background: var(--clear-hover-bg);
        color: var(--text-2);
      }
      .paste-pill-remove i {
        font-size: 9px;
        line-height: 1;
      }

      /* ─── Input area ─────────────────────────────── */
      .input-area {
        position: relative;
        z-index: 20;
        padding: 0.875rem 1.25rem 1.125rem;
        flex-shrink: 0;
      }
      .input-area::before {
        content: '';
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        height: 3rem;
        background: linear-gradient(to top, var(--bg), transparent);
        pointer-events: none;
      }

      .input-inner {
        max-width: 42rem;
        margin: 0 auto;
      }

      .input-card {
        background: var(--surface);
        border: 1px solid var(--border-hi);
        border-radius: var(--r);
        transition:
          border-color 0.2s,
          box-shadow 0.2s;
      }
      .input-card:focus-within {
        border-color: var(--focus-border);
        box-shadow:
          0 0 0 3px var(--focus-shadow),
          0 1px 3px var(--focus-shadow2);
      }
      .input-card.is-loading {
        border-color: var(--focus-border);
        animation: card-pulse 1.8s ease-in-out infinite;
      }
      @keyframes card-pulse {
        0%,
        100% {
          box-shadow: 0 0 0 3px var(--pulse-shadow);
        }
        50% {
          box-shadow: 0 0 0 3px var(--pulse-shadow2);
        }
      }

      .textarea-wrap {
        position: relative;
      }

      #prompt {
        display: block;
        width: 100%;
        padding: 0.875rem 2.75rem 0.75rem 1rem;
        font-family: var(--ui);
        font-size: 0.9375rem;
        font-weight: 400;
        line-height: 1.55;
        color: var(--text);
        background: transparent;
        border: none;
        outline: none;
        resize: none;
        min-height: 3rem;
        max-height: 11rem;
        overflow-y: hidden;
      }
      #prompt::placeholder {
        color: var(--text-3);
      }

      #clear {
        position: absolute;
        top: 0.5625rem;
        right: 0.5625rem;
        width: 24px;
        height: 24px;
        display: grid;
        place-items: center;
        background: transparent;
        border: none;
        border-radius: 6px;
        color: var(--text-3);
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        transition:
          opacity 0.15s,
          background 0.15s,
          color 0.15s;
      }
      #clear.show {
        opacity: 1;
        pointer-events: auto;
      }
      #clear:hover {
        background: var(--clear-hover-bg);
        color: var(--text-2);
      }
      #clear i {
        font-size: 13px;
        line-height: 1;
      }

      .input-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.4375rem 0.75rem 0.625rem;
        border-top: 1px solid var(--border);
      }

      .hint {
        font-size: 0.625rem;
        color: var(--text-3);
        letter-spacing: 0.025em;
        display: flex;
        align-items: center;
        gap: 0.3125rem;
      }
      .hint kbd {
        font-family: var(--mono);
        font-size: 0.5625rem;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: 3px;
        padding: 0.0625rem 0.3125rem;
        color: var(--text-2);
      }

      #submit {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.4375rem 0.9375rem;
        font-family: var(--ui);
        font-size: 0.8125rem;
        font-weight: 700;
        letter-spacing: 0.03em;
        color: var(--bg);
        background: var(--accent);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition:
          background 0.2s,
          box-shadow 0.2s,
          transform 0.1s,
          opacity 0.2s;
      }
      #submit:hover:not(:disabled) {
        background: var(--text-2);
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.14);
        transform: translateY(-1px);
      }
      #submit:active:not(:disabled) {
        transform: translateY(0);
      }
      #submit:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      #submit i {
        font-size: 14px;
        line-height: 1;
      }

      /* ─── Theme toggle ───────────────────────────── */
      .header-right {
        display: flex;
        align-items: center;
        gap: 0.625rem;
      }

      #theme-toggle {
        width: 32px;
        height: 32px;
        display: grid;
        place-items: center;
        background: var(--surface-2);
        border: 1px solid var(--border-hi);
        border-radius: 8px;
        color: var(--text-2);
        cursor: pointer;
        transition:
          background 0.15s,
          color 0.15s,
          border-color 0.15s;
        flex-shrink: 0;
      }
      #theme-toggle:hover {
        background: var(--border-hi);
        color: var(--text);
      }
      #theme-toggle i {
        font-size: 16px;
        line-height: 1;
      }

      /* icon visibility */
      #theme-toggle .icon-sun {
        display: none;
      }
      #theme-toggle .icon-moon {
        display: block;
      }
      html[data-theme='dark'] #theme-toggle .icon-sun {
        display: block;
      }
      html[data-theme='dark'] #theme-toggle .icon-moon {
        display: none;
      }

      /* smooth theme transition */
      body,
      .header,
      .input-card,
      .msg-bubble,
      .msg-badge,
      .status,
      .brand-icon,
      .ph-icon,
      .hint kbd {
        transition:
          background 0.2s,
          color 0.2s,
          border-color 0.2s;
      }

      /* ─── Credit footer ──────────────────────────── */
      .credit {
        text-align: center;
        font-size: 0.6875rem;
        color: var(--text-2);
        letter-spacing: 0.03em;
        margin-top: 0.875rem;
        padding-bottom: 0.25rem;
      }
      .credit a {
        color: var(--text-2);
        text-decoration: none;
        font-weight: 600;
        border-bottom: 1px solid var(--border-hi);
        padding-bottom: 1px;
        transition:
          color 0.15s,
          border-color 0.15s;
      }
      .credit a:hover {
        color: var(--text);
        border-color: var(--text);
      }

      /* ─── Responsive ─────────────────────────────── */
      @media (max-width: 600px) {
        .header {
          padding: 0.625rem 1rem;
        }
        .brand-name {
          font-size: 0.875rem;
        }
        .chat-inner {
          padding: 1.25rem 0.875rem 3.5rem;
          gap: 1.25rem;
        }
        .input-area {
          padding: 0.625rem 0.875rem 0.875rem;
        }
        .input-footer {
          flex-wrap: wrap;
          gap: 0.375rem;
        }
        .hint {
          font-size: 0.5625rem;
        }
        #submit {
          padding: 0.4375rem 0.75rem;
          font-size: 0.75rem;
        }
        .msg-bubble {
          max-width: 90%;
          font-size: 0.875rem;
        }
        .msg-text {
          font-size: 0.8125rem;
        }
        .ph-title {
          font-size: 0.875rem;
        }
        .ph-sub {
          font-size: 0.75rem;
        }
        #prompt {
          font-size: 0.875rem;
        }
      }

      @media (max-width: 380px) {
        .hint {
          display: none;
        }
        #submit {
          margin-left: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- ── Header ──────────────────────────── -->
    <header class="header">
      <div class="brand">
        <div class="brand-icon">
          <i class="hgi-stroke hgi-flash"></i>
        </div>
        <div class="brand-name">
          <span class="brand-name-main">AI<em>OS</em></span>
          <span
            class="brand-name-sub"
            id="brand-author"
            style="display: none"
          ></span>
        </div>
      </div>
      <div class="header-right">
        <div id="status" class="status">
          <span class="status-dot"></span>
          <span id="status-text">READY</span>
        </div>
        <button id="theme-toggle" aria-label="Toggle theme">
          <i class="hgi-stroke hgi-moon icon-moon"></i>
          <i class="hgi-stroke hgi-sun-01 icon-sun"></i>
        </button>
      </div>
    </header>

    <!-- ── Main ───────────────────────────── -->
    <main class="main">
      <div class="chat-wrap" id="chat-wrap">
        <div class="chat-inner" id="chat-inner">
          <div id="empty-state">
            <div class="ph-icon">
              <i class="hgi-stroke hgi-message-01"></i>
            </div>
            <p class="ph-title">What do you want to explore?</p>
            <p class="ph-sub">
              Send a message to start a conversation.<br />Shift+Enter for a new
              line.
            </p>
          </div>
        </div>
      </div>

      <!-- Input -->
      <div class="input-area">
        <div class="input-inner">
          <form id="form">
            <div class="input-card" id="input-card">
              <div id="paste-strip"></div>
              <div class="textarea-wrap">
                <textarea
                  id="prompt"
                  name="prompt"
                  placeholder="Ask anything…"
                  rows="1"
                  autocomplete="off"
                  spellcheck="false"
                ></textarea>
                <button type="button" id="clear" aria-label="Clear input">
                  <i class="hgi-stroke hgi-cancel-01"></i>
                </button>
              </div>
              <div class="input-footer">
                <span class="hint">
                  <kbd>Enter</kbd> send
                  <span style="opacity: 0.4">·</span>
                  <kbd>Shift+Enter</kbd> new line
                </span>
                <button type="submit" id="submit" disabled>
                  <i class="hgi-stroke hgi-arrow-up-01"></i>
                  Send
                </button>
              </div>
            </div>
          </form>
          <p class="credit" id="credit" style="display: none">
            Developed by
            <a
              id="credit-link"
              href="#"
              target="_blank"
              rel="noopener noreferrer"
            ></a>
          </p>
        </div>
      </div>
    </main>

    <script>
      marked.use({ breaks: true, gfm: true });

      // ── Branding (hydrated from env via /v1/branding) ──────────────
      (async function loadBranding() {
        try {
          const res = await fetch('/v1/branding');
          if (!res.ok) return;
          const { authorName, authorUrl } = await res.json();
          if (authorName) {
            const brandEl = document.getElementById('brand-author');
            brandEl.textContent = 'by ' + authorName;
            brandEl.style.display = '';
            const creditEl = document.getElementById('credit');
            const creditLink = document.getElementById('credit-link');
            creditLink.textContent = authorName;
            if (authorUrl) creditLink.href = authorUrl;
            creditEl.style.display = '';
          }
        } catch (_) {
          /* silently keep defaults */
        }
      })();

      const form = document.getElementById('form');
      const promptEl = document.getElementById('prompt');
      const submitBtn = document.getElementById('submit');
      const clearBtn = document.getElementById('clear');
      const statusEl = document.getElementById('status');
      const statusText = document.getElementById('status-text');
      const inputCard = document.getElementById('input-card');
      const chatWrap = document.getElementById('chat-wrap');
      const chatInner = document.getElementById('chat-inner');
      const emptyState = document.getElementById('empty-state');
      const themeToggle = document.getElementById('theme-toggle');
      const pasteStrip = document.getElementById('paste-strip');

      // ── Theme ──────────────────────────────────────
      const savedTheme = localStorage.getItem('aios-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', savedTheme);

      themeToggle.addEventListener('click', function () {
        const next =
          document.documentElement.getAttribute('data-theme') === 'dark'
            ? 'light'
            : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('aios-theme', next);
      });

      var userScrolledUp = false;
      var isAutoScrolling = false;

      chatWrap.addEventListener('scroll', function () {
        if (isAutoScrolling) return;
        var distFromBottom =
          chatWrap.scrollHeight - chatWrap.scrollTop - chatWrap.clientHeight;
        userScrolledUp = distFromBottom > 80;
      });

      // Used during streaming — only scrolls if user hasn't scrolled away
      function scrollToBottom() {
        if (!userScrolledUp) {
          isAutoScrolling = true;
          chatWrap.scrollTop = chatWrap.scrollHeight;
          requestAnimationFrame(function () {
            isAutoScrolling = false;
          });
        }
      }

      // Always scrolls — used when sending a new message
      function forceScrollToBottom() {
        userScrolledUp = false;
        isAutoScrolling = true;
        chatWrap.scrollTop = chatWrap.scrollHeight;
        requestAnimationFrame(function () {
          isAutoScrolling = false;
        });
      }

      // ── Status pill ────────────────────────────────
      const STATUS_MAP = {
        ready: { cls: '', label: 'READY' },
        thinking: { cls: 's-thinking', label: 'THINKING' },
        streaming: { cls: 's-streaming', label: 'REPLYING' },
        done: { cls: 's-done', label: 'DONE' },
        error: { cls: 's-error', label: 'ERROR' },
      };

      function setStatus(s) {
        const m = STATUS_MAP[s] || STATUS_MAP.ready;
        statusEl.className = 'status' + (m.cls ? ' ' + m.cls : '');
        statusText.textContent = m.label;
        inputCard.classList.toggle(
          'is-loading',
          s === 'thinking' || s === 'streaming',
        );
      }

      // ── Message builders ───────────────────────────
      function addUserMsg(typedText, pastedText, fullPrompt) {
        emptyState.classList.add('hidden');
        const row = document.createElement('div');
        row.className = 'msg msg-user';
        const bubble = document.createElement('div');
        bubble.className = 'msg-bubble';
        if (pastedText) {
          const lines = pastedText.split('\n').length;
          const pill = document.createElement('div');
          pill.className = 'msg-paste-pill';
          pill.appendChild(makeHgiIcon('file'));
          const lbl = document.createElement('span');
          lbl.textContent =
            'Pasted text \u00b7 ' + lines + ' line' + (lines !== 1 ? 's' : '');
          pill.appendChild(lbl);
          bubble.appendChild(pill);
        }
        if (typedText) {
          const textNode = document.createElement('span');
          textNode.style.cssText =
            'display:block' + (pastedText ? ';margin-top:0.375rem' : '');
          textNode.textContent = typedText;
          bubble.appendChild(textNode);
        }
        row.appendChild(bubble);

        const actions = document.createElement('div');
        actions.className = 'msg-actions msg-actions-user';

        const copyBtn = makeActionBtn('copy-01', 'Copy message');
        copyBtn.addEventListener('click', function () {
          navigator.clipboard.writeText(fullPrompt || typedText || '').then(function () {
            flashCheck(copyBtn);
          });
        });
        actions.appendChild(copyBtn);

        const editBtn = makeActionBtn('pencil-edit-01', 'Edit message');
        editBtn.addEventListener('click', function () {
          promptEl.value = typedText || '';
          if (pastedText) showPastePill(pastedText);
          resizePrompt();
          updateSubmitState();
          promptEl.focus();
        });
        actions.appendChild(editBtn);

        row.appendChild(actions);
        chatInner.appendChild(row);
        forceScrollToBottom();
      }

      function addAIMsg() {
        emptyState.classList.add('hidden');
        const row = document.createElement('div');
        row.className = 'msg msg-ai';

        const badge = document.createElement('span');
        badge.className = 'msg-badge';
        badge.textContent = '\u25CF AIOS';
        row.appendChild(badge);

        const thinkingEl = document.createElement('div');
        thinkingEl.className = 'msg-thinking';
        for (let i = 0; i < 3; i++) {
          const line = document.createElement('div');
          line.className = 'shimmer-line';
          thinkingEl.appendChild(line);
        }
        row.appendChild(thinkingEl);

        chatInner.appendChild(row);
        forceScrollToBottom();

        let textEl = null;

        return {
          startStream() {
            thinkingEl.remove();
            textEl = document.createElement('div');
            textEl.className = 'msg-text';
            row.appendChild(textEl);
            return textEl;
          },
          showError(msg) {
            thinkingEl.remove();
            const errEl = document.createElement('div');
            errEl.className = 'msg-error';
            errEl.textContent = '\u26A0  ' + msg;
            row.appendChild(errEl);
          },
          finalize(rawText) {
            if (/^\s*subject\s*:/im.test(rawText)) {
              // Replace plain streaming view with email card
              if (textEl) textEl.remove();
              renderEmailCard(rawText, row);
            } else {
              const actions = document.createElement('div');
              actions.className = 'msg-actions msg-actions-ai';

              const copyBtn = makeActionBtn('copy-01', 'Copy response');
              copyBtn.addEventListener('click', function () {
                navigator.clipboard.writeText(rawText).then(function () {
                  flashCheck(copyBtn);
                });
              });
              actions.appendChild(copyBtn);

              const shareBtn = makeActionBtn('share-08', 'Share response');
              shareBtn.addEventListener('click', async function () {
                if (navigator.share) {
                  try {
                    await navigator.share({ text: rawText });
                  } catch (_) {}
                } else {
                  await navigator.clipboard.writeText(rawText);
                  flashCheck(shareBtn);
                }
              });
              actions.appendChild(shareBtn);

              row.appendChild(actions);
            }
          },
        };
      }

      // ── Paste attachment ───────────────────────────
      const PASTE_THRESHOLD = 500;
      let pastedContent = null;

      function updateSubmitState() {
        const hasContent = promptEl.value.length > 0 || pastedContent !== null;
        clearBtn.classList.toggle('show', hasContent);
        submitBtn.disabled = !hasContent;
      }

      function clearPasteAttachment() {
        pastedContent = null;
        while (pasteStrip.firstChild)
          pasteStrip.removeChild(pasteStrip.firstChild);
        pasteStrip.classList.remove('has-pill');
      }

      function makeHgiIcon(name) {
        var i = document.createElement('i');
        i.className = 'hgi-stroke hgi-' + name;
        return i;
      }

      function makeActionBtn(iconName, label) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'msg-action-btn';
        btn.setAttribute('aria-label', label);
        btn.appendChild(makeHgiIcon(iconName));
        return btn;
      }

      function makeEmailIconBtn(iconName, label) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'msg-email-icon-btn';
        btn.setAttribute('aria-label', label);
        btn.appendChild(makeHgiIcon(iconName));
        return btn;
      }

      function flashCheck(btn) {
        var icon = btn.querySelector('i');
        var prev = icon.className;
        btn.classList.add('copied');
        icon.className = 'hgi-stroke hgi-tick-02';
        setTimeout(function () {
          icon.className = prev;
          btn.classList.remove('copied');
        }, 1500);
      }

      function renderEmailCard(rawText, row) {
        const subjectMatch = rawText.match(/^[ \t]*subject\s*:\s*(.+)$/im);
        const subject = subjectMatch ? subjectMatch[1].trim() : null;

        let body = rawText;
        if (subjectMatch) {
          body = (rawText.slice(0, subjectMatch.index) + rawText.slice(subjectMatch.index + subjectMatch[0].length)).trim();
        }

        const card = document.createElement('div');
        card.className = 'msg-email-card';

        // Header
        const hd = document.createElement('div');
        hd.className = 'msg-email-hd';

        const lbl = document.createElement('span');
        lbl.className = 'msg-email-label';
        lbl.textContent = 'Email';
        hd.appendChild(lbl);

        const hdActions = document.createElement('div');
        hdActions.className = 'msg-email-hd-actions';

        const copyBtn = makeEmailIconBtn('copy-01', 'Copy email');
        copyBtn.addEventListener('click', function () {
          navigator.clipboard.writeText(rawText).then(function () { flashCheck(copyBtn); });
        });
        hdActions.appendChild(copyBtn);

        const shareBtn = makeEmailIconBtn('share-08', 'Share email');
        shareBtn.addEventListener('click', async function () {
          if (navigator.share) {
            try { await navigator.share({ text: rawText }); } catch (_) {}
          } else {
            await navigator.clipboard.writeText(rawText);
            flashCheck(shareBtn);
          }
        });
        hdActions.appendChild(shareBtn);

        hd.appendChild(hdActions);
        card.appendChild(hd);

        // Subject line
        if (subject) {
          const subjectEl = document.createElement('div');
          subjectEl.className = 'msg-email-subject';
          const subjectLbl = document.createElement('span');
          subjectLbl.className = 'msg-email-subject-lbl';
          subjectLbl.textContent = 'Subject';
          const subjectTxt = document.createElement('span');
          subjectTxt.className = 'msg-email-subject-txt';
          subjectTxt.textContent = subject;
          subjectEl.appendChild(subjectLbl);
          subjectEl.appendChild(subjectTxt);
          card.appendChild(subjectEl);
        }

        // Body — highlight [placeholders] then render markdown
        const bodyEl = document.createElement('div');
        bodyEl.className = 'msg-email-body';
        const highlighted = body.replace(
          /\[([^\]\n]+)\]/g,
          '<span class="msg-email-placeholder">[$1]</span>'
        );
        bodyEl.innerHTML = DOMPurify.sanitize(marked.parse(highlighted)); // already sanitized
        card.appendChild(bodyEl);

        row.appendChild(card);
      }

      function showPastePill(text) {
        clearPasteAttachment();
        pastedContent = text;
        var lines = text.split('\n').length;

        var pill = document.createElement('div');
        pill.className = 'paste-pill';
        pill.appendChild(makeHgiIcon('file'));

        var label = document.createElement('span');
        label.className = 'paste-pill-label';
        label.textContent =
          'Pasted text \u00b7 ' + lines + ' line' + (lines !== 1 ? 's' : '');
        pill.appendChild(label);

        var rmBtn = document.createElement('button');
        rmBtn.type = 'button';
        rmBtn.className = 'paste-pill-remove';
        rmBtn.setAttribute('aria-label', 'Remove pasted text');
        rmBtn.appendChild(makeHgiIcon('cancel-01'));
        rmBtn.addEventListener('click', function () {
          clearPasteAttachment();
          updateSubmitState();
          promptEl.focus();
        });
        pill.appendChild(rmBtn);

        pasteStrip.appendChild(pill);
        pasteStrip.classList.add('has-pill');
      }

      promptEl.addEventListener('paste', function (e) {
        var text = (e.clipboardData || window.clipboardData).getData('text');
        if (text.length >= PASTE_THRESHOLD) {
          e.preventDefault();
          showPastePill(text);
          updateSubmitState();
        }
      });

      // ── Prompt resize ──────────────────────────────
      function resizePrompt() {
        promptEl.style.height = 'auto';
        var capped = Math.min(promptEl.scrollHeight, 264);
        promptEl.style.height = capped + 'px';
        promptEl.style.overflowY =
          promptEl.scrollHeight > 264 ? 'auto' : 'hidden';
      }

      promptEl.addEventListener('input', function () {
        resizePrompt();
        updateSubmitState();
      });

      promptEl.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          form.requestSubmit();
          return;
        }
        setTimeout(resizePrompt, 0);
      });

      clearBtn.addEventListener('click', function () {
        promptEl.value = '';
        promptEl.style.height = 'auto';
        clearPasteAttachment();
        clearBtn.classList.remove('show');
        submitBtn.disabled = true;
        promptEl.focus();
      });

      // ── Submit ─────────────────────────────────────
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const typedText = promptEl.value ? promptEl.value.trim() : '';
        const prompt = pastedContent
          ? typedText
            ? typedText + '\n\n' + pastedContent
            : pastedContent
          : typedText;
        if (!prompt) return;

        // Capture pasted content before clearing
        const snapPasted = pastedContent;

        // Clear input immediately
        promptEl.value = '';
        promptEl.style.height = 'auto';
        clearPasteAttachment();
        clearBtn.classList.remove('show');
        promptEl.blur();

        submitBtn.disabled = true;
        setStatus('thinking');

        addUserMsg(typedText, snapPasted, prompt);
        const aiMsg = addAIMsg();

        try {
          const apiUrl =
            (window.location.origin || 'http://localhost:3000') +
            '/v1/expose/prompt/stream';
          const res = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt }),
          });

          if (!res.ok) {
            let errMsg;
            try {
              const body = await res.json();
              if (res.status === 413) {
                errMsg =
                  'Message too large. Please shorten your input and try again.';
              } else {
                errMsg = body.message || 'Request failed: ' + res.status;
              }
            } catch (_) {
              errMsg = 'Request failed: ' + res.status;
            }
            aiMsg.showError(errMsg);
            setStatus('error');
            return;
          }

          if (!res.body) {
            aiMsg.showError('No response body from server.');
            setStatus('error');
            return;
          }

          setStatus('streaming');
          const textEl = aiMsg.startStream();
          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let text = '';

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            text += decoder.decode(value, { stream: true });
            textEl.innerHTML = DOMPurify.sanitize(marked.parse(text)); // already sanitized
            scrollToBottom();
          }

          if (text.length === 0) {
            aiMsg.showError(
              'No response from the model. Check server logs and AI_GATEWAY_API_KEY in .env.',
            );
            setStatus('error');
          } else {
            aiMsg.finalize(text);
            setStatus('done');
          }
        } catch (err) {
          aiMsg.showError(err.message || 'Network or stream error.');
          setStatus('error');
        } finally {
          submitBtn.disabled =
            promptEl.value.trim().length === 0 && pastedContent === null;
          inputCard.classList.remove('is-loading');
          if (window.innerWidth > 600) promptEl.focus();
        }
      });
    </script>
  </body>
</html>
